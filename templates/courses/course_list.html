{% extends 'base.html' %}
{% load static %}

{% block title %}My Courses - Dojo{% endblock %}

{% block content %}
<!-- Flash Messages -->
{% include 'components/messages.html' %}

<!-- CSRF Token for JavaScript -->
{% csrf_token %}

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                     My Courses
                </h2>
                <div class="d-flex gap-2 align-items-center">
                    <div class="search-container">
                        <input type="text" class="form-control" id="courseSearchInput" placeholder="Search courses..." style="border: 2px solid #000000; background-color: #FBF3D5; width: 200px; border-radius: 8px; padding: 8px 12px;">
                    </div>
                    <button type="button" class="btn btn-outline-secondary" id="selectModeBtn" onclick="toggleSelectMode()">
                        <i class="bi bi-three-dots"></i>
                    </button>
                    <button type="button" class="btn btn-custom" data-bs-toggle="modal" data-bs-target="#addCourseModal">
                        <i class="bi bi-plus-circle"></i> Add Course
                    </button>
                </div>
            </div>

            {% if courses %}
                <div class="row" id="coursesRow">
                    {% for course in courses %}
                        <div class="col-md-4 col-lg-3 mb-3">
                            <div class="course-folder" data-course-id="{{ course.id }}" style="cursor: pointer;">
                                <div class="folder-container text-center">
                                    <div class="folder-icon" style="color: {{ course.folder_color }};">
                                        <svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" id="folder" width="512" height="512" x="0" y="0" version="1.1" viewBox="0 0 512 512">
                                            <path d="M472 176H40c-4.411 0-8 3.589-8 8v239c0 13.317 11.683 25 25 25h400c12.683 0 23-11.215 23-25V184c0-4.411-3.589-8-8-8zM457 96H215c-2.791 0-4.271-.585-6.094-2.408l-22.501-22.501-.168-.162C181.365 66.333 177.361 64 169 64H57c-13.785 0-25 10.317-25 23v74.376A23.885 23.885 0 0 1 40 160h432c2.805 0 5.496.488 8 1.376V119c0-13.327-9.673-23-23-23z" fill="currentColor" stroke="black" stroke-width="2"></path>
                                            <text x="50" y="400" font-family="Arial, sans-serif" font-size="32" font-weight="bold" fill="black" text-anchor="start">{{ course.name }}</text>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <!-- Delete Button (Hidden by default) -->
                <div id="deleteSection" class="text-center mt-4" style="display: none;">
                    <button type="button" class="btn btn-danger" onclick="deleteSelectedCourses()">
                        <i class="bi bi-trash"></i> Delete Selected Courses
                    </button>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <img src="{% static 'img/icons/courses.png' %}" alt="Courses" style="width: 80px; height: 80px; opacity: 0.6;">
                    <h4 class="text-muted mt-3">No courses yet</h4>
                    <p class="text-muted">Start by adding your first course!</p>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCourseModal">
                        <i class="bi bi-plus-circle"></i> Add Your First Course
                    </button>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Course Modal -->
<div class="modal fade" id="addCourseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-center w-100">Add New Course</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'courses:add_course' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <!-- Folder Preview -->
                    <div class="text-center mb-4">
                        <div class="folder-preview" style="color: #B7B1F2;">
                            {% include 'components/folder.svg' %}
                        </div>
                    </div>
                    
                    <!-- Color Selection -->
                    <div class="mb-4">
                        <label class="form-label">Choose Folder Color</label>
                        <div class="color-options d-flex justify-content-center gap-2">
                            <div class="color-option" data-color="#B7B1F2" style="background-color: #B7B1F2; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid transparent;" onclick="selectColor('#B7B1F2')"></div>
                            <div class="color-option" data-color="#BFECFF" style="background-color: #BFECFF; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid transparent;" onclick="selectColor('#BFECFF')"></div>
                            <div class="color-option" data-color="#FFE0EF" style="background-color: #FFE0EF; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid transparent;" onclick="selectColor('#FFE0EF')"></div>
                            <div class="color-option" data-color="#C1CFA1" style="background-color: #C1CFA1; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid transparent;" onclick="selectColor('#C1CFA1')"></div>
                            <div class="color-option" data-color="#F0A04B" style="background-color: #F0A04B; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid transparent;" onclick="selectColor('#F0A04B')"></div>
                        </div>
                        <input type="hidden" id="id_folder_color" name="folder_color" value="#B7B1F2">
                    </div>
                    
                    <!-- Form Fields -->
                    <div class="mb-3">
                        <label for="id_name" class="form-label">Course</label>
                        <input type="text" class="form-control" id="id_name" name="name" placeholder="Enter course name" required>
                    </div>
                    <div class="mb-3">
                        <label for="id_instructor" class="form-label">Instructor</label>
                        <input type="text" class="form-control" id="id_instructor" name="instructor" placeholder="Enter instructor's name (Optional)">
                    </div>
                    <div class="mb-3">
                        <label for="id_room_location" class="form-label">Room Location</label>
                        <input type="text" class="form-control" id="id_room_location" name="room_location" placeholder="Enter room location (Optional)">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Include Add Todo Modal -->
{% include 'dashboard/add_todo_modal.html' %}

<script>
let selectMode = false;
let selectedCourses = new Set();

function selectColor(color) {
    // Update folder preview color
    document.querySelector('.folder-preview').style.color = color;
    
    // Update hidden input
    document.getElementById('id_folder_color').value = color;
    
    // Update color option selection
    document.querySelectorAll('.color-option').forEach(option => {
        option.style.border = '3px solid transparent';
    });
    event.target.style.border = '3px solid #333';
}

function toggleSelectMode() {
    selectMode = !selectMode;
    const selectBtn = document.getElementById('selectModeBtn');
    const deleteSection = document.getElementById('deleteSection');
    const courseFolders = document.querySelectorAll('.course-folder');
    
    if (selectMode) {
        // Enter select mode
        selectBtn.innerHTML = '<i class="bi bi-x"></i>';
        selectBtn.classList.remove('btn-outline-secondary');
        selectBtn.classList.add('btn-secondary');
        
        // Add click handlers for selection
        courseFolders.forEach(folder => {
            folder.onclick = function() {
                toggleCourseSelection(this);
            };
        });
    } else {
        // Exit select mode
        selectBtn.innerHTML = '<i class="bi bi-three-dots"></i>';
        selectBtn.classList.remove('btn-secondary');
        selectBtn.classList.add('btn-outline-secondary');
        
        // Reset to normal navigation
        courseFolders.forEach(folder => {
            const courseId = folder.getAttribute('data-course-id');
            folder.onclick = function() {
                openCourseDetailModal(courseId);
            };
            folder.classList.remove('selected');
        });
        
        // Hide delete section
        deleteSection.style.display = 'none';
        selectedCourses.clear();
    }
}

function toggleCourseSelection(folderElement) {
    const courseId = folderElement.getAttribute('data-course-id');
    
    if (selectedCourses.has(courseId)) {
        selectedCourses.delete(courseId);
        folderElement.classList.remove('selected');
    } else {
        selectedCourses.add(courseId);
        folderElement.classList.add('selected');
    }
    
    // Show/hide delete button based on selection
    const deleteSection = document.getElementById('deleteSection');
    if (selectedCourses.size > 0) {
        deleteSection.style.display = 'block';
    } else {
        deleteSection.style.display = 'none';
    }
}

function deleteSelectedCourses() {
    if (selectedCourses.size === 0) return;
    
    // Show custom confirmation modal
    showDeleteConfirmation(selectedCourses.size);
}

function showDeleteConfirmation(courseCount) {
    // Create modal HTML
    const modalHTML = `
        <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header border-0">
                        <h5 class="modal-title" id="deleteConfirmModalLabel">
                            <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                            Confirm Deletion
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <p class="mb-0">Are you sure you want to delete <strong>${courseCount}</strong> course${courseCount > 1 ? 's' : ''}?</p>
                        <p class="text-muted small mt-2">This action cannot be undone.</p>
                    </div>
                    <div class="modal-footer border-0 justify-content-center">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                            <i class="bi bi-trash me-1"></i>Delete Course${courseCount > 1 ? 's' : ''}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('deleteConfirmModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    modal.show();
    
    // Clean up modal after it's hidden
    document.getElementById('deleteConfirmModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

function confirmDelete() {
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // Close the confirmation modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
    modal.hide();
    
    // Delete each selected course
    selectedCourses.forEach(courseId => {
        fetch(`/courses/${courseId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            if (response.ok) {
                // Remove the folder from DOM
                const folderElement = document.querySelector(`[data-course-id="${courseId}"]`);
                if (folderElement) {
                    folderElement.closest('.col-md-4').remove();
                }
            }
        })
        .catch(error => {
            console.error('Error deleting course:', error);
            showToast('Error deleting course. Please try again.', 'danger');
        });
    });
    
    // Exit select mode
    toggleSelectMode();
    
    // Show success message
    showToast('Courses deleted successfully!', 'success');
}

function showToast(message, type) {
    // Create toast element
    const toastContainer = document.querySelector('.toast-container') || createToastContainer();
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    // Show toast
    const bsToast = new bootstrap.Toast(toast, { delay: 4000 });
    bsToast.show();
    
    // Remove toast element after it's hidden
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '1055';
    document.body.appendChild(container);
    return container;
}

// Initialize normal navigation on page load
document.addEventListener('DOMContentLoaded', function() {
    // Initialize label selection tabs
    initializeLabelTabs();
    
    const courseFolders = document.querySelectorAll('.course-folder');
    courseFolders.forEach(folder => {
        const courseId = folder.getAttribute('data-course-id');
        folder.onclick = function() {
            openCourseDetailModal(courseId);
        };
    });
});

function openCourseDetailModal(courseId) {
    // Get the course folder color from the clicked folder
    const courseFolder = document.querySelector(`[data-course-id="${courseId}"]`);
    const folderColor = courseFolder ? courseFolder.querySelector('.folder-icon').style.color : '#B7B1F2';
    
    // Fetch course detail content
    fetch(`/courses/${courseId}/detail-modal/`)
        .then(response => response.text())
        .then(html => {
            // Create modal container
            const modalHTML = `
                <div class="modal fade" id="courseDetailModal" tabindex="-1" aria-labelledby="courseDetailModalLabel" aria-hidden="true" data-course-id="${courseId}">
                    <div class="modal-dialog modal-xl modal-dialog-scrollable">
                        <div class="modal-content course-detail-modal" style="--course-color: ${folderColor}; --course-color-light: ${folderColor}80;">
                            <div class="modal-header-custom" style="background: linear-gradient(135deg, ${folderColor}, ${folderColor}80) !important;">
                                <button type="button" class="btn-close-custom" data-bs-dismiss="modal" aria-label="Close">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                            <div class="modal-body-custom modal-scrollable">
                                ${html}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('courseDetailModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('courseDetailModal'));
            modal.show();
            
            // Debug: Check if modal is visible
            console.log('Modal created:', document.getElementById('courseDetailModal'));
            console.log('Modal content:', document.querySelector('.course-detail-modal'));
            
            // Initialize selection tabs
            initializeSelectionTabs();
            
            // Initialize course todo handlers after modal is shown
            setTimeout(() => {
                initializeCourseTodoHandlers();
            }, 100);
            
            // Clean up modal after it's hidden
            document.getElementById('courseDetailModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        })
        .catch(error => {
            console.error('Error loading course details:', error);
            showToast('Error loading course details. Please try again.', 'danger');
        });
}

function initializeSelectionTabs() {
    const tabs = document.querySelectorAll('.selection-tab');
    const tabContents = document.querySelectorAll('.tab-pane');
    
    // Set "To-do" tab as active by default
    tabs.forEach(t => t.classList.remove('active'));
    tabContents.forEach(content => content.classList.remove('show', 'active'));
    
    const todosTab = document.querySelector('.selection-tab[data-tab="todos"]');
    const todosContent = document.getElementById('todos');
    
    if (todosTab && todosContent) {
        todosTab.classList.add('active');
        todosContent.classList.add('show', 'active');
    }
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const targetTab = this.getAttribute('data-tab');
            
            // Update active tab
            tabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // Show/hide tab content
            tabContents.forEach(content => {
                if (content.id === targetTab) {
                    content.classList.add('show', 'active');
                } else {
                    content.classList.remove('show', 'active');
                }
            });
        });
    });
}

function uploadCourseImage(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        const formData = new FormData();
        formData.append('image', file);
        
        // Get course ID from the modal
        const courseId = document.querySelector('#courseDetailModal').getAttribute('data-course-id');
        
        // Show loading state
        const imageSection = document.querySelector('.course-image-section');
        imageSection.innerHTML = `
            <div class="course-image-placeholder">
                <i class="bi bi-hourglass-split" style="font-size: 2rem; color: #B7B1F2;"></i>
                <p class="text-muted mt-2">Uploading image...</p>
            </div>
        `;
        
        fetch(`/courses/${courseId}/upload-image/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the image display
                imageSection.innerHTML = `
                    <img src="${data.image_url}" alt="Course Image" class="course-image">
                    <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="document.getElementById('courseImageInput').click()">
                        <i class="bi bi-pencil"></i> Change Image
                    </button>
                `;
                showToast('Course image uploaded successfully!', 'success');
            } else {
                // Restore placeholder
                imageSection.innerHTML = `
                    <div class="course-image-placeholder">
                        <i class="bi bi-image" style="font-size: 3rem; color: #ccc;"></i>
                        <p class="text-muted mt-2">No course image</p>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('courseImageInput').click()">
                            <i class="bi bi-plus-circle"></i> Add Image
                        </button>
                    </div>
                `;
                showToast('Error uploading image. Please try again.', 'danger');
            }
        })
        .catch(error => {
            console.error('Error uploading image:', error);
            // Restore placeholder
            imageSection.innerHTML = `
                <div class="course-image-placeholder">
                    <i class="bi bi-image" style="font-size: 3rem; color: #ccc;"></i>
                    <p class="text-muted mt-2">No course image</p>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('courseImageInput').click()">
                        <i class="bi bi-plus-circle"></i> Add Image
                    </button>
                </div>
            `;
            showToast('Error uploading image. Please try again.', 'danger');
        });
    }
}

// Function to filter course todos
function filterCourseTodos(filterType) {
    const courseId = document.querySelector('#courseDetailModal').getAttribute('data-course-id');
    const currentUrl = `/courses/${courseId}/detail-modal/?filter=${filterType}`;
    
    fetch(currentUrl)
        .then(response => response.text())
        .then(html => {
            // Update the modal body content
            const modalBody = document.querySelector('#courseDetailModal .modal-body-custom');
            modalBody.innerHTML = html;
            
            // Reinitialize any necessary event listeners
            initializeCourseTodoHandlers();
        })
        .catch(error => {
            console.error('Error filtering todos:', error);
        });
}

// Function to open course todo dialog
function openCourseTodoDialog(todoId, title, description, dueDate) {
    // Store todo data for editing
    window.todoData = {
        id: todoId,
        title: title,
        description: description,
        dueDate: dueDate
    };
    
    // Show the action dialog
    const actionModal = new bootstrap.Modal(document.getElementById('todoActionModal'));
    actionModal.show();
}

    // Function to initialize label selection tabs
    function initializeLabelTabs() {
        const labelTabs = document.querySelectorAll('.label-tab');
        
        labelTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const labelType = this.getAttribute('data-label-type');
                
                // Update active tab
                labelTabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Show/hide appropriate dropdown
                const customDropdown = document.getElementById('custom-label-dropdown');
                const courseDropdown = document.getElementById('course-label-dropdown');
                
                if (labelType === 'custom') {
                    customDropdown.style.display = 'block';
                    courseDropdown.style.display = 'none';
                    // Clear course selection
                    document.getElementById('course_label').value = '';
                } else if (labelType === 'course') {
                    customDropdown.style.display = 'none';
                    courseDropdown.style.display = 'block';
                    // Clear custom selection
                    document.getElementById('custom_label').value = '';
                }
            });
        });
    }

    // Function to initialize course todo handlers
    function initializeCourseTodoHandlers() {
        // Handle todo checkbox toggles in course modal
        const todoCheckboxes = document.querySelectorAll('#courseDetailModal .todo-toggle');
        
        todoCheckboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', function() {
                const todoId = this.getAttribute('data-todo-id');
                const isChecked = this.checked;
                const todoItem = this.closest('.todo-item');
                
                // Get CSRF token
                const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
                
                // Optimistic UI update
                if (isChecked) {
                    todoItem.classList.add('completed');
                } else {
                    todoItem.classList.remove('completed');
                }
                
                // Make the AJAX request
                fetch(`/dashboard/todo/${todoId}/toggle/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.completed) {
                        // Revert optimistic update if failed
                        if (isChecked) {
                            todoItem.classList.remove('completed');
                            checkbox.checked = false;
                        } else {
                            todoItem.classList.add('completed');
                            checkbox.checked = true;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Revert optimistic update on error
                    if (isChecked) {
                        todoItem.classList.remove('completed');
                        checkbox.checked = false;
                    } else {
                        todoItem.classList.add('completed');
                        checkbox.checked = true;
                    }
                });
            });
        });
        
        // Initialize label tabs in course todo modal
        const labelTabs = document.querySelectorAll('#courseDetailModal .label-tab');
        
        labelTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const labelType = this.getAttribute('data-label-type');
                
                // Update active tab
                labelTabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Show/hide appropriate dropdown
                const customDropdown = document.getElementById('course-custom-label-dropdown');
                const courseDropdown = document.getElementById('course-course-label-dropdown');
                
                if (labelType === 'custom') {
                    customDropdown.style.display = 'block';
                    courseDropdown.style.display = 'none';
                    // Clear course selection
                    document.getElementById('course_course_label').value = '';
                } else if (labelType === 'course') {
                    customDropdown.style.display = 'none';
                    courseDropdown.style.display = 'block';
                    // Clear custom selection
                    document.getElementById('course_custom_label').value = '';
                }
            });
        });
        

    }
</script>

<style>
.course-folder {
    transition: transform 0.2s ease;
    position: relative;
}

.course-folder:hover {
    transform: scale(1.05);
}

.course-folder.selected {
    transform: scale(1.05);
}

.course-folder.selected::after {
    content: '';
    position: absolute;
    top: -5px;
    right: -5px;
    width: 25px;
    height: 25px;
    background-color: var(--success-color);
    border: 3px solid white;
    border-radius: 50%;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23fff' d='M6.564.75l-3.59 3.612-1.538-1.55L0 4.26 2.974 7.25 8 2.193z'/%3e%3c/svg%3e");
    background-size: 12px;
    background-position: center;
    background-repeat: no-repeat;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.folder-container {
    padding: 0;
    background: transparent;
    border-radius: 0;
    box-shadow: none;
    border: none;
    width: 230px;
    height: 230px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
}

.folder-icon {
    margin-bottom: 15px;
}

.folder-icon svg {
    width: 230px;
    height: 230px;
    filter: drop-shadow(0 0 2px rgba(0,0,0,0.3));
}

.folder-icon svg text {
    font-weight: bold;
    font-size: 32px;
    fill: black;
    text-anchor: start;
}

.color-option:hover {
    transform: scale(1.1);
    transition: transform 0.2s ease;
}

.folder-preview svg {
    width: 120px;
    height: 120px;
    filter: drop-shadow(0 0 2px rgba(0,0,0,0.3));
}

/* Modal styling is now in dojo.css */

.course-detail-modal .card {
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border: 2px solid #e0e0e0;
    transition: transform 0.2s ease;
}

.course-detail-modal .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

.course-detail-modal .nav-tabs {
    border-bottom: 2px solid var(--primary-color);
}

.course-detail-modal .nav-tabs .nav-link {
    border-radius: 10px 10px 0 0;
    border: 2px solid transparent;
    margin-right: 5px;
    font-weight: 500;
    transition: all 0.2s ease;
}

.course-detail-modal .nav-tabs .nav-link:hover {
    border-color: var(--primary-color);
    background-color: rgba(183, 177, 242, 0.1);
}

.course-detail-modal .nav-tabs .nav-link.active {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
    color: white;
}

.course-detail-modal .tab-content {
    padding: 1.5rem 0;
}

.course-detail-modal .btn {
    border-radius: 10px;
    font-weight: 500;
    transition: all 0.2s ease;
}

.course-detail-modal .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
}

.btn-custom {
    background-color: #FBF3D5;
    border: 2px solid #000000;
    color: #000000;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-custom:hover {
    background-color: #F0E6C7;
    border-color: #000000;
    color: #000000;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.btn-custom:focus {
    background-color: #FBF3D5;
    border-color: #000000;
    color: #000000;
    box-shadow: 0 0 0 0.2rem rgba(0,0,0,0.25);
}

/* Edit Course Modal Styles */
.color-picker {
    margin-top: 10px;
}

.color-options {
    display: flex;
    gap: 15px;
    justify-content: center;
}

.color-option {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    transition: transform 0.2s ease;
    position: relative;
}

.color-option:hover {
    transform: scale(1.1);
}

.color-option:has(input:checked) {
    transform: scale(1.2);
    box-shadow: 0 0 0 3px #000000;
}

.color-option:has(input:checked)::after {
    content: 'âœ“';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #000000;
    font-weight: bold;
    font-size: 16px;
}
</style>

<!-- Edit Course Modal -->
<div class="modal fade" id="editCourseModal" tabindex="-1" aria-labelledby="editCourseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border: 2px solid #000000; background-color: #FBF3D5;">
            <div class="modal-header" style="background-color: #FBF3D5; border-bottom: 2px solid #000000;">
                <h5 class="modal-title" id="editCourseModalLabel" style="color: #000000; font-weight: bold;">Edit Course</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" id="editCourseForm" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <!-- Course Name -->
                    <div class="mb-4">
                        <label for="edit_course_name" class="form-label fw-bold" style="color: #000000;">Course Name</label>
                        <input type="text" class="form-control" id="edit_course_name" name="name" required style="border: 2px solid #000000; background-color: #FFFFFF;">
                    </div>

                    <!-- Instructor (Optional) -->
                    <div class="mb-4">
                        <label for="edit_course_instructor" class="form-label fw-bold" style="color: #000000;">Instructor (Optional)</label>
                        <input type="text" class="form-control" id="edit_course_instructor" name="instructor" style="border: 2px solid #000000; background-color: #FFFFFF;">
                    </div>

                    <!-- Room Location (Optional) -->
                    <div class="mb-4">
                        <label for="edit_course_room" class="form-label fw-bold" style="color: #000000;">Room Location (Optional)</label>
                        <input type="text" class="form-control" id="edit_course_room" name="room_location" style="border: 2px solid #000000; background-color: #FFFFFF;">
                    </div>

                    <!-- Course Color -->
                    <div class="mb-4">
                        <label class="form-label fw-bold" style="color: #000000;">Course Color</label>
                        <div class="color-picker">
                            <div class="color-options">
                                <input type="radio" id="edit-color-ffe0ef" name="folder_color" value="#FFE0EF" style="display: none;">
                                <label for="edit-color-ffe0ef" class="color-option" style="background-color: #FFE0EF; border: 2px solid #000000;"></label>
                                
                                <input type="radio" id="edit-color-BFECFF" name="folder_color" value="#BFECFF" style="display: none;">
                                <label for="edit-color-BFECFF" class="color-option" style="background-color: #BFECFF; border: 2px solid #000000;"></label>
                                
                                <input type="radio" id="edit-color-B7B1F2" name="folder_color" value="#B7B1F2" style="display: none;">
                                <label for="edit-color-B7B1F2" class="color-option" style="background-color: #B7B1F2; border: 2px solid #000000;"></label>
                                
                                <input type="radio" id="edit-color-c1cfa1" name="folder_color" value="#C1CFA1" style="display: none;">
                                <label for="edit-color-c1cfa1" class="color-option" style="background-color: #C1CFA1; border: 2px solid #000000;"></label>
                                
                                <input type="radio" id="edit-color-f0a04b" name="folder_color" value="#F0A04B" style="display: none;">
                                <label for="edit-color-f0a04b" class="color-option" style="background-color: #F0A04B; border: 2px solid #000000;"></label>
                            </div>
                        </div>
                    </div>

                    <!-- Current Course Image Preview -->
                    <div class="mb-4" id="currentImagePreview" style="display: none;">
                        <label class="form-label fw-bold" style="color: #000000;">Current Course Image</label>
                        <div class="text-center">
                            <img id="currentCourseImage" alt="Current course image" style="width: 150px; height: 150px; object-fit: cover; border-radius: 10px; border: 2px solid #000000;">
                        </div>
                    </div>

                    <!-- New Course Image -->
                    <div class="mb-4">
                        <label for="edit_course_image" class="form-label fw-bold" style="color: #000000;">New Course Image (Optional)</label>
                        <input type="file" class="form-control" id="edit_course_image" name="image" accept="image/*" style="border: 2px solid #000000; background-color: #FFFFFF;">
                        <small class="text-muted">Leave empty to keep the current image</small>
                    </div>
                </div>
                <div class="modal-footer" style="background-color: #FBF3D5; border-top: 2px solid #000000;">
                    <button type="button" class="btn btn-outline-dark" data-bs-dismiss="modal" style="border: 2px solid #000000; background-color: #FBF3D5;">Cancel</button>
                    <button type="submit" class="btn btn-outline-dark" style="border: 2px solid #000000; background-color: #FBF3D5;">
                        <i class="bi bi-check-circle"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Function to open edit course modal with course data (global function)
window.openEditCourseModal = function(courseId) {
    // Check if Bootstrap is available
    if (typeof bootstrap === 'undefined') {
        alert('Bootstrap is not loaded. Please refresh the page.');
        return;
    }
    
    // Get course data from the current modal context
    const currentCourseName = document.querySelector('.course-name')?.textContent?.trim() || '';
    const currentInstructor = document.querySelectorAll('.info-value')[0]?.textContent?.trim() || '';
    const currentRoomLocation = document.querySelectorAll('.info-value')[1]?.textContent?.trim() || '';
    
    // Set form action
    const editForm = document.getElementById('editCourseForm');
    if (!editForm) {
        alert('Edit form not found. Please refresh the page.');
        return;
    }
    
    editForm.setAttribute('data-course-id', courseId);
    editForm.action = `/courses/${courseId}/edit/`;
    
    // Populate form fields
    const nameField = document.getElementById('edit_course_name');
    const instructorField = document.getElementById('edit_course_instructor');
    const roomField = document.getElementById('edit_course_room');
    
    if (nameField) {
        nameField.value = currentCourseName;
    }
    if (instructorField) {
        instructorField.value = currentInstructor === 'No instructor assigned' ? '' : currentInstructor;
    }
    if (roomField) {
        roomField.value = currentRoomLocation === 'No room assigned' ? '' : currentRoomLocation;
    }
    
    // Set default color
    const colorInput = document.querySelector('#edit-color-B7B1F2');
    if (colorInput) {
        colorInput.checked = true;
        const colorOption = colorInput.closest('.color-option');
        if (colorOption) {
            colorOption.classList.add('selected');
        }
    } else {
        // Try alternative selector
        const altColorInput = document.querySelector('input[name="folder_color"][value="#B7B1F2"]');
        if (altColorInput) {
            altColorInput.checked = true;
        }
    }
    
    // Hide current image preview for now (can be enhanced later)
    const imagePreview = document.getElementById('currentImagePreview');
    if (imagePreview) imagePreview.style.display = 'none';
    
    // Show modal
    const editModalElement = document.getElementById('editCourseModal');
    if (editModalElement) {
        try {
            const editModal = new bootstrap.Modal(editModalElement);
            editModal.show();
            
            // Check if modal is actually visible after a short delay
            setTimeout(() => {
                if (!editModalElement.classList.contains('show')) {
                    // Try to force show the modal
                    editModalElement.style.display = 'block';
                    editModalElement.classList.add('show');
                    editModalElement.style.zIndex = '9999';
                    editModalElement.style.position = 'fixed';
                }
            }, 100);
            
        } catch (error) {
            alert('Error showing modal: ' + error.message);
        }
    } else {
        alert('Edit modal element not found. Please refresh the page.');
    }
}

// Initialize edit course modal functionality
document.addEventListener('DOMContentLoaded', function() {

    // Course search functionality
    const courseSearchInput = document.getElementById('courseSearchInput');
    if (courseSearchInput) {
        courseSearchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            const courseFolders = document.querySelectorAll('.course-folder');
            
            courseFolders.forEach(folder => {
                const courseName = folder.querySelector('text').textContent.toLowerCase();
                const courseContainer = folder.closest('.col-md-4');
                
                if (courseName.includes(searchTerm)) {
                    courseContainer.style.display = 'block';
                } else {
                    courseContainer.style.display = 'none';
                }
            });
            
            // Show/hide "no results" message
            const visibleCourses = document.querySelectorAll('.col-md-4[style*="display: block"], .col-md-4:not([style*="display: none"])');
            const noResultsMessage = document.getElementById('noSearchResults');
            
            if (searchTerm && visibleCourses.length === 0) {
                if (!noResultsMessage) {
                    const noResults = document.createElement('div');
                    noResults.id = 'noSearchResults';
                    noResults.className = 'text-center py-5';
                    noResults.innerHTML = `
                        <img src="/static/img/icons/courses.png" alt="Courses" style="width: 80px; height: 80px; opacity: 0.6;">
                        <h4 class="text-muted mt-3">No courses found</h4>
                        <p class="text-muted">Try a different search term</p>
                    `;
                    document.getElementById('coursesRow').appendChild(noResults);
                }
            } else if (noResultsMessage) {
                noResultsMessage.remove();
            }
        });
    }

    // Color picker functionality for edit modal
    const editColorOptions = document.querySelectorAll('#editCourseModal .color-option');
    editColorOptions.forEach(option => {
        option.addEventListener('click', function() {
            // Remove checked from all options in edit modal
            editColorOptions.forEach(opt => opt.classList.remove('selected'));
            // Add checked to clicked option
            this.classList.add('selected');
            // Check the radio button
            this.querySelector('input').checked = true;
        });
    });

    // Handle edit course form submission
    const editForm = document.getElementById('editCourseForm');
    if (editForm) {
        editForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const courseId = this.getAttribute('data-course-id');
            
            fetch(`/courses/${courseId}/edit/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close the edit modal
                    const editModal = bootstrap.Modal.getInstance(document.getElementById('editCourseModal'));
                    editModal.hide();
                    
                    // Show success message
                    if (typeof showToast === 'function') {
                        showToast('Course updated successfully!', 'success');
                    } else {
                        alert('Course updated successfully!');
                    }
                    
                    // Reload the page to show updated course
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    // Show error message
                    if (typeof showToast === 'function') {
                        showToast('Error updating course. Please try again.', 'danger');
                    } else {
                        alert('Error updating course. Please try again.');
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (typeof showToast === 'function') {
                    showToast('Error updating course. Please try again.', 'danger');
                } else {
                    alert('Error updating course. Please try again.');
                }
            });
        });
    }
});
</script>
{% endblock %}
