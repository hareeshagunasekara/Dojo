{% extends 'base.html' %}
{% load static %}

{% block title %}My Courses - Dojo{% endblock %}

{% block content %}
<!-- Flash Messages -->
{% include 'components/messages.html' %}

<!-- CSRF Token for JavaScript -->
{% csrf_token %}

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                     My Courses
                </h2>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-secondary" id="selectModeBtn" onclick="toggleSelectMode()">
                        <i class="bi bi-three-dots"></i>
                    </button>
                    <button type="button" class="btn btn-custom" data-bs-toggle="modal" data-bs-target="#addCourseModal">
                        <i class="bi bi-plus-circle"></i> Add Course
                    </button>
                </div>
            </div>

            {% if courses %}
                <div class="row" id="coursesRow">
                    {% for course in courses %}
                        <div class="col-md-4 col-lg-3 mb-3">
                            <div class="course-folder" data-course-id="{{ course.id }}" style="cursor: pointer;">
                                <div class="folder-container text-center">
                                    <div class="folder-icon" style="color: {{ course.folder_color }};">
                                        <svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" id="folder" width="512" height="512" x="0" y="0" version="1.1" viewBox="0 0 512 512">
                                            <path d="M472 176H40c-4.411 0-8 3.589-8 8v239c0 13.317 11.683 25 25 25h400c12.683 0 23-11.215 23-25V184c0-4.411-3.589-8-8-8zM457 96H215c-2.791 0-4.271-.585-6.094-2.408l-22.501-22.501-.168-.162C181.365 66.333 177.361 64 169 64H57c-13.785 0-25 10.317-25 23v74.376A23.885 23.885 0 0 1 40 160h432c2.805 0 5.496.488 8 1.376V119c0-13.327-9.673-23-23-23z" fill="currentColor" stroke="black" stroke-width="2"></path>
                                            <text x="50" y="400" font-family="Arial, sans-serif" font-size="32" font-weight="bold" fill="black" text-anchor="start">{{ course.name }}</text>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <!-- Delete Button (Hidden by default) -->
                <div id="deleteSection" class="text-center mt-4" style="display: none;">
                    <button type="button" class="btn btn-danger" onclick="deleteSelectedCourses()">
                        <i class="bi bi-trash"></i> Delete Selected Courses
                    </button>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <img src="{% static 'img/icons/courses.png' %}" alt="Courses" style="width: 80px; height: 80px; opacity: 0.6;">
                    <h4 class="text-muted mt-3">No courses yet</h4>
                    <p class="text-muted">Start by adding your first course!</p>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCourseModal">
                        <i class="bi bi-plus-circle"></i> Add Your First Course
                    </button>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Course Modal -->
<div class="modal fade" id="addCourseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-center w-100">Add New Course</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'courses:add_course' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <!-- Folder Preview -->
                    <div class="text-center mb-4">
                        <div class="folder-preview" style="color: #B7B1F2;">
                            {% include 'components/folder.svg' %}
                        </div>
                    </div>
                    
                    <!-- Color Selection -->
                    <div class="mb-4">
                        <label class="form-label">Choose Folder Color</label>
                        <div class="color-options d-flex justify-content-center gap-2">
                            <div class="color-option" data-color="#B7B1F2" style="background-color: #B7B1F2; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid transparent;" onclick="selectColor('#B7B1F2')"></div>
                            <div class="color-option" data-color="#BFECFF" style="background-color: #BFECFF; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid transparent;" onclick="selectColor('#BFECFF')"></div>
                            <div class="color-option" data-color="#FFE0EF" style="background-color: #FFE0EF; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid transparent;" onclick="selectColor('#FFE0EF')"></div>
                            <div class="color-option" data-color="#C1CFA1" style="background-color: #C1CFA1; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid transparent;" onclick="selectColor('#C1CFA1')"></div>
                            <div class="color-option" data-color="#F0A04B" style="background-color: #F0A04B; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid transparent;" onclick="selectColor('#F0A04B')"></div>
                        </div>
                        <input type="hidden" id="id_folder_color" name="folder_color" value="#B7B1F2">
                    </div>
                    
                    <!-- Form Fields -->
                    <div class="mb-3">
                        <label for="id_name" class="form-label">Course</label>
                        <input type="text" class="form-control" id="id_name" name="name" placeholder="Enter course name" required>
                    </div>
                    <div class="mb-3">
                        <label for="id_instructor" class="form-label">Instructor</label>
                        <input type="text" class="form-control" id="id_instructor" name="instructor" placeholder="Enter instructor's name (Optional)">
                    </div>
                    <div class="mb-3">
                        <label for="id_room_location" class="form-label">Room Location</label>
                        <input type="text" class="form-control" id="id_room_location" name="room_location" placeholder="Enter room location (Optional)">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let selectMode = false;
let selectedCourses = new Set();

function selectColor(color) {
    // Update folder preview color
    document.querySelector('.folder-preview').style.color = color;
    
    // Update hidden input
    document.getElementById('id_folder_color').value = color;
    
    // Update color option selection
    document.querySelectorAll('.color-option').forEach(option => {
        option.style.border = '3px solid transparent';
    });
    event.target.style.border = '3px solid #333';
}

function toggleSelectMode() {
    selectMode = !selectMode;
    const selectBtn = document.getElementById('selectModeBtn');
    const deleteSection = document.getElementById('deleteSection');
    const courseFolders = document.querySelectorAll('.course-folder');
    
    if (selectMode) {
        // Enter select mode
        selectBtn.innerHTML = '<i class="bi bi-x"></i>';
        selectBtn.classList.remove('btn-outline-secondary');
        selectBtn.classList.add('btn-secondary');
        
        // Add click handlers for selection
        courseFolders.forEach(folder => {
            folder.onclick = function() {
                toggleCourseSelection(this);
            };
        });
    } else {
        // Exit select mode
        selectBtn.innerHTML = '<i class="bi bi-three-dots"></i>';
        selectBtn.classList.remove('btn-secondary');
        selectBtn.classList.add('btn-outline-secondary');
        
        // Reset to normal navigation
        courseFolders.forEach(folder => {
            const courseId = folder.getAttribute('data-course-id');
            folder.onclick = function() {
                window.location.href = `/courses/${courseId}/`;
            };
            folder.classList.remove('selected');
        });
        
        // Hide delete section
        deleteSection.style.display = 'none';
        selectedCourses.clear();
    }
}

function toggleCourseSelection(folderElement) {
    const courseId = folderElement.getAttribute('data-course-id');
    
    if (selectedCourses.has(courseId)) {
        selectedCourses.delete(courseId);
        folderElement.classList.remove('selected');
    } else {
        selectedCourses.add(courseId);
        folderElement.classList.add('selected');
    }
    
    // Show/hide delete button based on selection
    const deleteSection = document.getElementById('deleteSection');
    if (selectedCourses.size > 0) {
        deleteSection.style.display = 'block';
    } else {
        deleteSection.style.display = 'none';
    }
}

function deleteSelectedCourses() {
    if (selectedCourses.size === 0) return;
    
    // Show custom confirmation modal
    showDeleteConfirmation(selectedCourses.size);
}

function showDeleteConfirmation(courseCount) {
    // Create modal HTML
    const modalHTML = `
        <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header border-0">
                        <h5 class="modal-title" id="deleteConfirmModalLabel">
                            <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                            Confirm Deletion
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <p class="mb-0">Are you sure you want to delete <strong>${courseCount}</strong> course${courseCount > 1 ? 's' : ''}?</p>
                        <p class="text-muted small mt-2">This action cannot be undone.</p>
                    </div>
                    <div class="modal-footer border-0 justify-content-center">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                            <i class="bi bi-trash me-1"></i>Delete Course${courseCount > 1 ? 's' : ''}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('deleteConfirmModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    modal.show();
    
    // Clean up modal after it's hidden
    document.getElementById('deleteConfirmModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

function confirmDelete() {
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // Close the confirmation modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
    modal.hide();
    
    // Delete each selected course
    selectedCourses.forEach(courseId => {
        fetch(`/courses/${courseId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            if (response.ok) {
                // Remove the folder from DOM
                const folderElement = document.querySelector(`[data-course-id="${courseId}"]`);
                if (folderElement) {
                    folderElement.closest('.col-md-4').remove();
                }
            }
        })
        .catch(error => {
            console.error('Error deleting course:', error);
            showToast('Error deleting course. Please try again.', 'danger');
        });
    });
    
    // Exit select mode
    toggleSelectMode();
    
    // Show success message
    showToast('Courses deleted successfully!', 'success');
}

function showToast(message, type) {
    // Create toast element
    const toastContainer = document.querySelector('.toast-container') || createToastContainer();
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    // Show toast
    const bsToast = new bootstrap.Toast(toast, { delay: 4000 });
    bsToast.show();
    
    // Remove toast element after it's hidden
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '1055';
    document.body.appendChild(container);
    return container;
}

// Initialize normal navigation on page load
document.addEventListener('DOMContentLoaded', function() {
    const courseFolders = document.querySelectorAll('.course-folder');
    courseFolders.forEach(folder => {
        const courseId = folder.getAttribute('data-course-id');
        folder.onclick = function() {
            window.location.href = `/courses/${courseId}/`;
        };
    });
});
</script>

<style>
.course-folder {
    transition: transform 0.2s ease;
    position: relative;
}

.course-folder:hover {
    transform: scale(1.05);
}

.course-folder.selected {
    transform: scale(1.05);
}

.course-folder.selected::after {
    content: '';
    position: absolute;
    top: -5px;
    right: -5px;
    width: 25px;
    height: 25px;
    background-color: var(--success-color);
    border: 3px solid white;
    border-radius: 50%;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23fff' d='M6.564.75l-3.59 3.612-1.538-1.55L0 4.26 2.974 7.25 8 2.193z'/%3e%3c/svg%3e");
    background-size: 12px;
    background-position: center;
    background-repeat: no-repeat;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.folder-container {
    padding: 0;
    background: transparent;
    border-radius: 0;
    box-shadow: none;
    border: none;
    width: 230px;
    height: 230px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
}

.folder-icon {
    margin-bottom: 15px;
}

.folder-icon svg {
    width: 230px;
    height: 230px;
    filter: drop-shadow(0 0 2px rgba(0,0,0,0.3));
}

.folder-icon svg text {
    font-weight: bold;
    font-size: 32px;
    fill: black;
    text-anchor: start;
}

.color-option:hover {
    transform: scale(1.1);
    transition: transform 0.2s ease;
}

.folder-preview svg {
    width: 120px;
    height: 120px;
    filter: drop-shadow(0 0 2px rgba(0,0,0,0.3));
}

.btn-custom {
    background-color: #FBF3D5;
    border: 2px solid #000000;
    color: #000000;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-custom:hover {
    background-color: #F0E6C7;
    border-color: #000000;
    color: #000000;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.btn-custom:focus {
    background-color: #FBF3D5;
    border-color: #000000;
    color: #000000;
    box-shadow: 0 0 0 0.2rem rgba(0,0,0,0.25);
}
</style>
{% endblock %}
